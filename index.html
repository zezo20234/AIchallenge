<!DOCTYPE html>
<html>
<head>
  <title>Daily Lazuzu Challenge</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
    #challengeBox { 
      border: 2px solid #333; 
      padding: 20px; 
      display: inline-block; 
      border-radius: 10px; 
      background: #f8f8f8; 
      max-width: 400px;
    }
    button { 
      background: #4CAF50; 
      color: white; 
      padding: 10px 20px; 
      font-size: 16px; 
      border: none; 
      border-radius: 5px; 
      cursor: pointer; 
    }
    button:disabled { background: gray; cursor: not-allowed; }
  </style>
</head>
<body>

<h1>Daily Lazuzu Challenge</h1>
<div id="challengeBox" style="display:none;">
  <h2 id="challengeTitle"></h2>
  <p id="challengeDesc"></p>
  <button id="doneBtn">I Did It!</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyAjeXycCBhYoAU-0iiC4LbSTylKrrThN8Y",
    authDomain: "sharplabubu.firebaseapp.com",
    databaseURL: "https://sharplabubu-default-rtdb.firebaseio.com",
    projectId: "sharplabubu",
    storageBucket: "sharplabubu.firebasestorage.app",
    messagingSenderId: "596148393481",
    appId: "1:596148393481:web:4f822d86c44a13bd810ad8",
    measurementId: "G-4M25R3BF08"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// 50 challenges without any drawing or writing
const challenges = [
  { title: "Do 10 Jumping Jacks", desc: "Get active by doing 10 jumping jacks in a row." },
  { title: "Tell a Joke", desc: "Tell a funny joke to a family member." },
  { title: "Learn a New Word", desc: "Learn and explain a new word." },
  { title: "Do a Puzzle", desc: "Complete any puzzle you have at home." },
  { title: "Sing a Song", desc: "Perform a short song you know." },
  { title: "Count Your Toys", desc: "Count all your toys and sort them." },
  { title: "Dance for 2 Minutes", desc: "Dance to your favorite song." },
  { title: "Jump on One Foot", desc: "See how long you can hop on one foot." },
  { title: "Spin Around 5 Times", desc: "Spin in place five times without falling." },
  { title: "Clap 20 Times", desc: "Clap your hands 20 times as fast as you can." },
  { title: "Balance a Book on Your Head", desc: "Walk 5 steps while balancing a book." },
  { title: "Touch Your Toes", desc: "Touch your toes and count to 10." },
  { title: "Run in Place for 30 Seconds", desc: "Pretend you’re running a race at home." },
  { title: "Make a Funny Face", desc: "Make the silliest face you can for 5 seconds." },
  { title: "Pretend to Be an Animal", desc: "Walk around like your favorite animal." },
  { title: "High Five Everyone in the Room", desc: "Give a high five to each person nearby." },
  { title: "Count to 50 Backwards", desc: "Count backwards from 50 without stopping." },
  { title: "March in Place", desc: "March like a soldier for 1 minute." },
  { title: "Freeze Dance", desc: "Dance until someone says 'freeze' and hold still." },
  { title: "Pretend to Swim", desc: "Do swimming motions for 30 seconds." },
  { title: "Say Hello in 3 Languages", desc: "Greet someone in 3 different languages." },
  { title: "Jump Rope 20 Times", desc: "Jump rope 20 times without stopping." },
  { title: "Read a Page Aloud", desc: "Read one page of your favorite book out loud." },
  { title: "Count Your Steps for 2 Minutes", desc: "Count your steps as you walk around." },
  { title: "Make a Paper Airplane", desc: "Fold and fly a paper airplane." },
  { title: "Name 5 Animals", desc: "Name five different animals aloud." },
  { title: "Touch Your Nose with Your Eyes Closed", desc: "Try to touch your nose without looking." },
  { title: "Hop Like a Bunny for 1 Minute", desc: "Hop around like a bunny for one minute." },
  { title: "Say the Alphabet Backwards", desc: "Try to say the alphabet backwards." },
  { title: "Tell a Riddle to Someone", desc: "Tell a riddle and see if they can solve it." },
  { title: "Make a Shadow Puppet", desc: "Create a shadow puppet on the wall." },
  { title: "Count Colors in the Room", desc: "Count how many colors you see around you." },
  { title: "Say a Tongue Twister 3 Times Fast", desc: "Try to say a tricky tongue twister fast." },
  { title: "Name 3 Fruits", desc: "Say the names of three fruits." },
  { title: "Clap a Rhythm and Ask Someone to Repeat", desc: "Make a clapping rhythm and have someone copy it." },
  { title: "Pretend to Fly Like a Bird", desc: "Flap your arms and pretend to fly." },
  { title: "Find a Leaf and Describe It", desc: "Look outside for a leaf and describe it." },
  { title: "Make a Funny Noise for 5 Seconds", desc: "Make a silly noise." },
  { title: "Say a Compliment to Someone", desc: "Say something nice to someone near you." },
  { title: "Build a Pillow Fort", desc: "Use pillows to build a small fort." },
  { title: "Name 3 Countries", desc: "Name three countries you know." },
  { title: "Jump as High as You Can 5 Times", desc: "Jump high five times in a row." },
  { title: "Smile at 3 People Today", desc: "Give a smile to three different people." },
  { title: "Tell Someone Your Favorite Food", desc: "Say what food you like best." },
  { title: "Say 'Please' and 'Thank You' 3 Times", desc: "Practice polite words." },
  { title: "Pretend to Sleep for 10 Seconds", desc: "Act like you’re sleeping." },
  { title: "Sing Your Favorite Nursery Rhyme", desc: "Sing a nursery rhyme you like." },
  { title: "Count How Many Windows Are in Your House", desc: "Count all windows you can see." }
];

// Rewards from 1000 to 2500, steps of 100
const rewardOptions = [];
for (let r = 1000; r <= 2500; r += 100) rewardOptions.push(r);

// Time slots config (24-hour format)
const timeSlots = [
  { startHour: 11:30, endHour: 12:30, slotId: "morning" },
  { startHour: 15, endHour: 16, slotId: "afternoon" }, // 3-4 PM
  { startHour: 20, endHour: 21, slotId: "evening" }    // 8-9 PM
];

// Get challenge index for a given day and slot (2 challenges per day)
function getChallengeIndex(dayNum, slotIndex) {
    const index = (dayNum * 2 + slotIndex) % challenges.length;
    return index;
}

// Returns current slot index or -1 if no slot active
function getCurrentSlotIndex() {
    const now = new Date();
    const hour = now.getHours();
    for (let i = 0; i < timeSlots.length; i++) {
        if (hour >= timeSlots[i].startHour && hour < timeSlots[i].endHour) {
            return i;
        }
    }
    return -1;
}

async function showChallenge() {
    const now = new Date();
    const dayNum = now.getDate();
    const slotIndex = getCurrentSlotIndex();
    const challengeBox = document.getElementById("challengeBox");
    const doneBtn = document.getElementById("doneBtn");

    if (slotIndex === -1) {
        challengeBox.style.display = "none";
        return;
    }

    const challengeIndex = getChallengeIndex(dayNum, slotIndex);
    const challenge = challenges[challengeIndex];

    document.getElementById("challengeTitle").textContent = challenge.title;
    document.getElementById("challengeDesc").textContent = challenge.desc;
    challengeBox.style.display = "inline-block";

    // Get username from localStorage or prompt
    let username = localStorage.getItem("username");
    if (!username) {
      username = prompt("Enter your username:");
      if (!username) {
        doneBtn.disabled = true;
        doneBtn.textContent = "Enter username to claim";
        return;
      }
      username = username.trim().toLowerCase();
      localStorage.setItem("username", username);
    }

    const todayDate = now.toISOString().split('T')[0]; // yyyy-mm-dd
    const userRef = ref(db, `users/${username}`);

    try {
        const snapshot = await get(userRef);

        let lastChallengeDate = null;
        let claimedSlots = [];

        if (snapshot.exists()) {
            lastChallengeDate = snapshot.val().lastChallengeDate || null;
            claimedSlots = snapshot.val().claimedSlots || [];
        }

        if (lastChallengeDate === todayDate && claimedSlots.includes(timeSlots[slotIndex].slotId)) {
            doneBtn.disabled = true;
            doneBtn.textContent = "Challenge Completed This Slot!";
        } else {
            doneBtn.disabled = false;
            doneBtn.textContent = "I Did It!";
        }

    } catch (error) {
        console.error("Error fetching user data:", error);
        doneBtn.disabled = true;
        doneBtn.textContent = "Error loading challenge";
    }
}

document.getElementById("doneBtn").onclick = async () => {
    const doneBtn = document.getElementById("doneBtn");
    doneBtn.disabled = true;

    let username = localStorage.getItem("username");
    if (!username) {
      username = prompt("Enter your username:");
      if (!username) {
        alert("Username is required to claim reward.");
        doneBtn.disabled = false;
        return;
      }
      username = username.trim().toLowerCase();
      localStorage.setItem("username", username);
    }

    const now = new Date();
    const dayNum = now.getDate();
    const slotIndex = getCurrentSlotIndex();

    if (slotIndex === -1) {
      alert("No active challenge to claim right now.");
      doneBtn.disabled = false;
      return;
    }

    const challengeIndex = getChallengeIndex(dayNum, slotIndex);

    const userRef = ref(db, `users/${username}`);

    try {
        const snapshot = await get(userRef);

        const todayDate = now.toISOString().split('T')[0];
        let currentCredits = 0;
        let lastChallengeDate = null;
        let claimedSlots = [];

        if (snapshot.exists()) {
            currentCredits = snapshot.val().credits || 0;
            lastChallengeDate = snapshot.val().lastChallengeDate || null;
            claimedSlots = snapshot.val().claimedSlots || [];
        }

        if (lastChallengeDate === todayDate && claimedSlots.includes(timeSlots[slotIndex].slotId)) {
            alert("❌ You have already completed this challenge slot today!");
            return;
        }

        // Pick random reward from 1000 to 2500 in steps of 100
        const reward = rewardOptions[Math.floor(Math.random() * rewardOptions.length)];

        // Reset claimed slots if new day
        if (lastChallengeDate !== todayDate) {
          claimedSlots = [];
        }
        claimedSlots.push(timeSlots[slotIndex].slotId);

        await update(userRef, {
            credits: currentCredits + reward,
            lastChallengeDate: todayDate,
            claimedSlots: claimedSlots
        });

        alert(`🎉 You earned ${reward} Lazuzu!`);
        doneBtn.disabled = true;
        doneBtn.textContent = "Challenge Completed!";
    } catch (error) {
        console.error("Error updating user data:", error);
        alert("Error processing your request, please try again.");
        doneBtn.disabled = false;
    }
};

(async () => {
  await showChallenge();
  setInterval(showChallenge, 60000);
})();
</script>

</body>
</html>
